(function(a){a.fn.extend({BlackAndWhite:function(g){var G=this,f=a.extend({hoverEffect:true,webworkerPath:false,invertHoverEffect:false,speed:500,onImageReady:null,intensity:1},g),l=f.hoverEffect,c=f.webworkerPath,b=f.invertHoverEffect,k=(typeof f.intensity==="number"&&f.intensity<1&&f.intensity>0)?f.intensity:1,F=a.isPlainObject(f.speed)?f.speed.fadeIn:f.speed,z=a.isPlainObject(f.speed)?f.speed.fadeOut:f.speed,v=a(window),n=".BlackAndWhite",h=(document.all&&!window.opera&&window.XMLHttpRequest)?true:false,r=" -webkit- -moz- -o- -ms- ".split(" "),d={},i=function(J){if(d[J]||d[J]===""){return d[J]+J}var K=document.createElement("div"),I=["","Moz","Webkit","O","ms","Khtml"];for(var H in I){if(typeof K.style[I[H]+J]!=="undefined"){d[J]=I[H];return I[H]+J}}return J.toLowerCase()},t=(function(){var H=document.createElement("div");H.style.cssText=r.join("filter:blur(2px); ");return !!H.style.length&&((document.documentMode===undefined||document.documentMode>9))}()),u=!!document.createElement("canvas").getContext,e=(function(){return(typeof(Worker)!=="undefined")?true:false}()),E=i("Filter"),q=[],D=e&&c?new Worker(c+"BnWWorker.js"):false,m=function(H){a(H.currentTarget).find(".BWfade").stop(true,true).animate({opacity:b?0:1},z)},B=function(H){a(H.currentTarget).find(".BWfade").stop(true,true).animate({opacity:b?1:0},F)},A=function(H){if(typeof f.onImageReady==="function"){f.onImageReady(H)}},s=function(H){if(D&&u&&!t&&!H){p()}},p=function(){if(!q.length){if(D.terminate){D.terminate()}if(D.close){D.close()}return}D.postMessage({imgData:q[0].imageData,intensity:k});D.onmessage=function(H){q[0].ctx.putImageData(H.data,0,0);A(q[0].img);q.splice(0,1);p()}},j=function(H){return H.complete||(typeof H.naturalWidth!=="undefined"&&H.naturalWidth)},y=function(O,K,I,R){var S=K.getContext("2d"),M=O,N=0,P;S.drawImage(O,0,0,I,R);var H=S.getImageData(0,0,I,R),Q=H.data,J=Q.length;if(D){q.push({imageData:H,ctx:S,img:O})}else{for(;N<J;N+=4){var L=Q[N]*0.3+Q[N+1]*0.59+Q[N+2]*0.11;Q[N]=~~(L*k+Q[N]*(1-k));Q[N+1]=~~(L*k+Q[N+1]*(1-k));Q[N+2]=~~(L*k+Q[N+2]*(1-k))}S.putImageData(H,0,0);A(O)}},x=function(K,L){var I=K[0],N=I.src,M=K.position(),J={top:M.top,left:M.left,position:"absolute","-webkit-transform":"translate3d(0,0,0)",opacity:b?0:1},H;I.crossOrigin="anonymous";if(u&&!t){H=a('<canvas width="'+I.naturalWidth+'" height="'+I.naturalHeight+'" class="BWfade"></canvas>');J.width=K.width();J.height=K.height();y(I,H.get(0),I.naturalWidth,I.naturalHeight)}else{if(u){J[E]="grayscale("+k*100+"%)"}else{J.filter="progid:DXImageTransform.Microsoft.BasicImage(grayscale=1)"}H=K.clone().addClass("BWFilter BWfade");A(I)}H.css(J).prependTo(L);if(!a.support.opacity&&b){H.animate({opacity:0},0)}},w=function(){G.each(function(J,L){var I=a(L).find("img"),H=a(I).width(),K=a(I).height();a(this).find("canvas").css({width:H,height:K})})},o=function(){var H=G.find("img").filter(function(){return !a(this).data("_b&w")}).length;G.each(function(J,I){var L=a(I),K=L.find("img");if(K.data("_b&w")){return}if(!j(K[0])){K.on("load",function(){if(K.data("_b&w_loaded")||!K[0].complete){setTimeout(function(){K.load()},20);return}x(K,L);K.data("_b&w_loaded",true);H--;s(H)}).load()}else{H--;x(K,L)}K.data("_b&w",true)});s(H);if(l){G.unbind(n).on("mouseleave"+n,m).on("mouseenter"+n,B)}if(u&&!t){v.unbind(n).on("resize"+n+" orientationchange"+n,w)}};var C=function(){G.off(n);v.off(n)};o();return{destroy:C}}})}(jQuery));